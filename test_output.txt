
> code-ally@0.1.0 test
> vitest


 RUN  v3.2.4 /Users/benmoore/CodeAlly-TS

 ❯ src/security/__tests__/PathSecurity.test.ts (19 tests | 2 failed) 8ms
   ✓ PathSecurity > isPathWithinCwd > should allow paths within the current working directory 1ms
   ✓ PathSecurity > isPathWithinCwd > should reject paths outside the current working directory 0ms
   ✓ PathSecurity > isPathWithinCwd > should reject parent directory traversal 0ms
   × PathSecurity > hasPathTraversalPatterns > should detect parent directory traversal patterns 4ms
     → expected false to be true // Object.is equality
   × PathSecurity > hasPathTraversalPatterns > should detect home directory patterns 0ms
     → expected false to be true // Object.is equality
   ✓ PathSecurity > hasPathTraversalPatterns > should detect dangerous system paths 0ms
   ✓ PathSecurity > hasPathTraversalPatterns > should detect command substitution patterns 0ms
   ✓ PathSecurity > hasPathTraversalPatterns > should allow safe relative paths within CWD 0ms
   ✓ PathSecurity > hasPathTraversalPatterns > should allow absolute paths within CWD 0ms
   ✓ PathSecurity > hasPathTraversalPatterns > should handle glob patterns correctly 0ms
   ✓ PathSecurity > hasDangerousPathPatterns > should detect extremely dangerous file access patterns 0ms
   ✓ PathSecurity > hasDangerousPathPatterns > should detect dangerous system paths 0ms
   ✓ PathSecurity > hasDangerousPathPatterns > should detect command substitution 0ms
   ✓ PathSecurity > hasDangerousPathPatterns > should allow normal paths 0ms
   ✓ PathSecurity > getCommandSensitivityTier > should classify extremely sensitive commands 1ms
   ✓ PathSecurity > getCommandSensitivityTier > should classify sensitive commands 0ms
   ✓ PathSecurity > getCommandSensitivityTier > should classify normal commands 0ms
   ✓ PathSecurity > Error classes > should create DirectoryTraversalError correctly 0ms
   ✓ PathSecurity > Error classes > should create PermissionDeniedError correctly 0ms
 ❯ src/services/__tests__/CompletionProvider.test.ts (29 tests | 4 failed) 46ms
   × CompletionProvider > slash command completions > should complete slash commands 5ms
     → expected undefined to be defined
   × CompletionProvider > slash command completions > should return all commands for single slash 2ms
     → expected [ 'help', 'config', 'clear', …(11) ] to include '/help'
   × CompletionProvider > slash command completions > should filter commands by prefix 2ms
     → expected [ 'config', 'compact', 'context' ] to include '/config'
   × CompletionProvider > slash command completions > should include descriptions 0ms
     → expected undefined to be defined
   ✓ CompletionProvider > slash command completions > should not complete when cursor not at end 0ms
   ✓ CompletionProvider > agent subcommand completions > should complete agent subcommands 0ms
   ✓ CompletionProvider > agent subcommand completions > should filter agent subcommands 0ms
   ✓ CompletionProvider > agent subcommand completions > should complete agent names for "use" subcommand 2ms
   ✓ CompletionProvider > agent subcommand completions > should filter agent names by prefix 2ms
   ✓ CompletionProvider > @agent syntax completions > should complete agent names with @ prefix 1ms
   ✓ CompletionProvider > @agent syntax completions > should filter by prefix after @ 1ms
   ✓ CompletionProvider > @agent syntax completions > should mark completions as agent type 1ms
   ✓ CompletionProvider > file path completions > should complete files with paths 1ms
   ✓ CompletionProvider > file path completions > should handle directory paths 1ms
   ✓ CompletionProvider > file path completions > should recognize paths with slashes as file paths 0ms
   ✓ CompletionProvider > file path completions > should limit file completions to 20 results 12ms
   ✓ CompletionProvider > file path completions > should handle mixed files and directories 2ms
   ✓ CompletionProvider > context detection > should detect command context 0ms
   ✓ CompletionProvider > context detection > should detect agent context 2ms
   ✓ CompletionProvider > context detection > should return empty for plain text 1ms
   ✓ CompletionProvider > agent cache > should cache agent names 3ms
   ✓ CompletionProvider > agent cache > should expire cache after TTL 2ms
   ✓ CompletionProvider > utility methods > should return slash commands 1ms
   ✓ CompletionProvider > utility methods > should return agent subcommands 1ms
   ✓ CompletionProvider > edge cases > should handle empty input 1ms
   ✓ CompletionProvider > edge cases > should handle cursor at start 1ms
   ✓ CompletionProvider > edge cases > should handle multiline input 1ms
   ✓ CompletionProvider > edge cases > should handle missing agent manager gracefully 1ms
   ✓ CompletionProvider > edge cases > should handle non-existent directory for file completion 1ms
 ❯ src/tests/tools/BaseTool.test.ts (11 tests | 4 failed) 6ms
   × BaseTool > execute > should emit TOOL_CALL_START event 3ms
     → expected undefined to be defined
   × BaseTool > execute > should emit TOOL_CALL_END event on success 0ms
     → expected undefined to be defined
   × BaseTool > execute > should emit ERROR event on failure 0ms
     → expected undefined to be defined
   ✓ BaseTool > formatErrorResponse > should format error with tool name 0ms
   ✓ BaseTool > formatErrorResponse > should include suggestion if provided 0ms
   ✓ BaseTool > formatErrorResponse > should include error type 0ms
   ✓ BaseTool > formatSuccessResponse > should format success response 0ms
   ✓ BaseTool > getResultPreview > should return error preview for failed results 0ms
   ✓ BaseTool > getResultPreview > should return content preview for successful results 0ms
   ✓ BaseTool > getResultPreview > should skip internal-only results 0ms
   × BaseTool > captureParams > should filter out undefined and null values 1ms
     → expected 'mock_tool(shouldFail=true): Mock error' to contain 'param1'
 ❯ src/tests/tools/ToolManager.test.ts (12 tests | 3 failed) 8ms
   ✓ ToolManager > getTool > should retrieve registered tool by name 1ms
   ✓ ToolManager > getTool > should return undefined for unknown tool 0ms
   ✓ ToolManager > getAllTools > should return all registered tools 0ms
   ✓ ToolManager > getFunctionDefinitions > should generate function definitions for all tools 0ms
   ✓ ToolManager > executeTool > should execute tool with valid arguments 0ms
   ✓ ToolManager > executeTool > should return error for unknown tool 0ms
   ✓ ToolManager > executeTool > should detect redundant calls in same turn 0ms
   ✓ ToolManager > executeTool > should allow same call after clearing turn 0ms
   × ToolManager > file tracking > should track read files 4ms
     → expected false to be true // Object.is equality
   × ToolManager > file tracking > should track write files 1ms
     → expected false to be true // Object.is equality
   × ToolManager > file tracking > should return timestamp for read files 0ms
     → expected undefined to be defined
   ✓ ToolManager > clearState > should clear all tracked state 0ms
 ✓ src/services/__tests__/ProjectManager.test.ts (16 tests) 66ms
 ❯ src/services/__tests__/UndoManager.test.ts (15 tests | 1 failed) 74ms
   ✓ UndoManager > recordOperation > should record a write operation 4ms
   ✓ UndoManager > recordOperation > should store small content inline 1ms
   ✓ UndoManager > recordOperation > should backup large content to file 2ms
   ✓ UndoManager > recordOperation > should maintain history limit 2ms
   ✓ UndoManager > undo > should undo a write operation 3ms
   ✓ UndoManager > undo > should undo a create operation 2ms
   ✓ UndoManager > undo > should undo multiple operations 7ms
   ✓ UndoManager > undo > should return error if no operations to undo 2ms
   × UndoManager > undo > should handle invalid count 8ms
     → expected 'No operations to undo' to contain 'Invalid count'
   ✓ UndoManager > getHistory > should return history in reverse order (most recent first) 3ms
   ✓ UndoManager > getHistory > should limit history when requested 5ms
   ✓ UndoManager > clearHistory > should clear all history 3ms
   ✓ UndoManager > clearHistory > should clean up backup files 7ms
   ✓ UndoManager > getFormattedHistory > should format history for display 21ms
   ✓ UndoManager > getFormattedHistory > should show message if no history 5ms
 ✓ src/services/__tests__/MemoryManager.test.ts (18 tests) 105ms
 ❯ src/tests/tools/FocusManagerTool.test.ts (12 tests | 4 failed) 91ms
   ✓ FocusManagerTool > metadata > should have correct metadata 3ms
   × FocusManagerTool > show action > should show no focus when not set 6ms
     → the given combination of arguments (undefined and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string
   ✓ FocusManagerTool > show action > should show current focus when set 3ms
   ✓ FocusManagerTool > set action > should set focus to current directory 5ms
   ✓ FocusManagerTool > set action > should reject missing path parameter 2ms
   × FocusManagerTool > set action > should reject non-existent directory 10ms
     → expected 'focus(action="set", path="nonexistent…' to contain 'not accessible'
   ✓ FocusManagerTool > set action > should reject absolute paths 2ms
   × FocusManagerTool > clear action > should clear focus 20ms
     → the given combination of arguments (undefined and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string
   × FocusManagerTool > clear action > should succeed even when no focus is set 7ms
     → the given combination of arguments (undefined and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string
   ✓ FocusManagerTool > validation > should reject missing action parameter 16ms
   ✓ FocusManagerTool > validation > should reject invalid action 9ms
   ✓ FocusManagerTool > integration > should support full focus lifecycle 7ms
 ✓ src/tools/__tests__/WriteTool.test.ts (20 tests) 118ms
 ❯ src/agent/__tests__/CommandHandler.test.ts (26 tests | 26 failed) 91ms
   × CommandHandler > parseCommand > should parse simple commands 9ms
     → agentManager.initialize is not a function
   × CommandHandler > parseCommand > should parse commands with arguments 4ms
     → agentManager.initialize is not a function
   × CommandHandler > parseCommand > should ignore non-commands 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /help 5ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /config-show 5ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /config set 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /config-reset 7ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /model 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /model <name> 5ms
     → agentManager.initialize is not a function
   × CommandHandler > Core Commands > should handle /debug 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Agent Commands > should handle /agent ls 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Agent Commands > should handle /agent show 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Agent Commands > should handle /agent delete 8ms
     → agentManager.initialize is not a function
   × CommandHandler > Focus Commands > should handle /focus without args 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Focus Commands > should handle /focus <path> 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Focus Commands > should handle /defocus 4ms
     → agentManager.initialize is not a function
   × CommandHandler > Focus Commands > should handle /focus-show 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Memory Commands > should handle /memory add 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Memory Commands > should handle /memory ls 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Memory Commands > should handle /memory clear 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Project Commands > should handle /project view 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Project Commands > should handle /project clear 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Utility Commands > should handle /undo 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Utility Commands > should handle /undo with count 3ms
     → agentManager.initialize is not a function
   × CommandHandler > Error Handling > should handle unknown commands 2ms
     → agentManager.initialize is not a function
   × CommandHandler > Error Handling > should handle invalid config values 3ms
     → agentManager.initialize is not a function
 ✓ src/tools/__tests__/EditTool.test.ts (24 tests) 131ms
 ✓ src/services/__tests__/ServiceRegistry.test.ts (30 tests) 15ms
 ❯ src/tests/tools/AgentTool.test.ts (13 tests | 12 failed) 120ms
   ✓ AgentTool > metadata > should have correct metadata 11ms
   × AgentTool > validation > should reject missing agents parameter 13ms
     → expected 'agent(): task_prompt parameter is req…' to contain 'agents parameter is required'
   × AgentTool > validation > should reject empty agents array 10ms
     → expected 'agent(): task_prompt parameter is req…' to contain 'at least one agent spec'
   × AgentTool > validation > should reject non-array agents parameter 11ms
     → expected 'agent(agents="not an array"): task_pr…' to contain 'at least one agent spec'
   × AgentTool > validation > should reject agent spec without task_prompt 7ms
     → expected 'agent(agents=[{"agent_name":"general"…' to contain 'missing required field: task_prompt'
   × AgentTool > validation > should reject non-string task_prompt 9ms
     → expected 'agent(agents=[{"task_prompt":123}]): …' to contain 'task_prompt must be a string'
   × AgentTool > validation > should reject non-string agent_name 8ms
     → expected 'agent(agents=[{"agent_name":123,"task…' to contain 'agent_name must be a string'
   × AgentTool > execution > should execute single agent delegation 11ms
     → expected false to be true // Object.is equality
   × AgentTool > execution > should use default agent when agent_name not specified 8ms
     → expected false to be true // Object.is equality
   × AgentTool > execution > should fail when agent does not exist 8ms
     → expected false to be true // Object.is equality
   × AgentTool > execution > should execute multiple agents concurrently 8ms
     → expected false to be true // Object.is equality
   × AgentTool > execution > should include duration in results 8ms
     → expected false to be true // Object.is equality
   × AgentTool > event emission > should emit AGENT_START and AGENT_END events 9ms
     → expected 0 to be greater than 0
 ❯ src/services/__tests__/ConfigManager.test.ts (26 tests | 3 failed) 181ms
   ✓ ConfigManager > initialization > should initialize with default config when no file exists 7ms
   ✓ ConfigManager > initialization > should create config file on initialization 10ms
   ✓ ConfigManager > initialization > should load existing config file 6ms
   × ConfigManager > initialization > should handle invalid JSON gracefully 9ms
     → ENOENT: no such file or directory, open '/var/folders/7v/q0dhh46j7zn5gs9zfcqmk2tm0000gn/T/code-ally-test-1761184477888/config.json'
   ✓ ConfigManager > getValue > should get existing config values 13ms
   × ConfigManager > getValue > should return default value for missing keys 5ms
     → ENOENT: no such file or directory, open '/var/folders/7v/q0dhh46j7zn5gs9zfcqmk2tm0000gn/T/code-ally-test-1761184477910/config.json'
   ✓ ConfigManager > getValue > should handle all config types correctly 8ms
   × ConfigManager > setValue > should set valid string values 3ms
     → ENOENT: no such file or directory, open '/var/folders/7v/q0dhh46j7zn5gs9zfcqmk2tm0000gn/T/code-ally-test-1761184477923/config.json'
   ✓ ConfigManager > setValue > should set valid number values 8ms
   ✓ ConfigManager > setValue > should set valid boolean values 9ms
   ✓ ConfigManager > setValue > should reject invalid types 8ms
   ✓ ConfigManager > setValue > should coerce string numbers 10ms
   ✓ ConfigManager > setValue > should coerce string booleans 7ms
   ✓ ConfigManager > setValues > should set multiple values at once 7ms
   ✓ ConfigManager > setValues > should validate all values before applying any 6ms
   ✓ ConfigManager > setValues > should reject unknown keys 6ms
   ✓ ConfigManager > reset > should reset all values to defaults 6ms
   ✓ ConfigManager > reset > should not report unchanged values 5ms
   ✓ ConfigManager > import/export > should export config as JSON 4ms
   ✓ ConfigManager > import/export > should import valid config JSON 4ms
   ✓ ConfigManager > import/export > should reject invalid JSON 6ms
   ✓ ConfigManager > import/export > should reject non-object JSON 7ms
   ✓ ConfigManager > utility methods > should check if key exists 7ms
   ✓ ConfigManager > utility methods > should return all keys 9ms
   ✓ ConfigManager > IService lifecycle > should implement initialize method 4ms
   ✓ ConfigManager > IService lifecycle > should implement cleanup method 6ms
 ✓ src/tools/__tests__/LineEditTool.test.ts (31 tests) 207ms
 ✓ src/llm/__tests__/FunctionCalling.test.ts (31 tests) 6ms
 ✓ src/cli/__tests__/ArgumentParser.test.ts (37 tests) 9ms
 ❯ src/tests/tools/ReadTool.test.ts (14 tests | 1 failed) 211ms
   ✓ ReadTool > basic properties > should have correct name 7ms
   ✓ ReadTool > basic properties > should not require confirmation 9ms
   ✓ ReadTool > basic properties > should have function definition 7ms
   ✓ ReadTool > execute > should read single file 7ms
   ✓ ReadTool > execute > should read multiple files 11ms
   ✓ ReadTool > execute > should include line numbers 8ms
   ✓ ReadTool > execute > should respect limit parameter 59ms
   ✓ ReadTool > execute > should respect offset parameter 16ms
   × ReadTool > execute > should handle non-existent file 24ms
     → expected false to be true // Object.is equality
   ✓ ReadTool > execute > should require file_paths parameter 14ms
   ✓ ReadTool > execute > should reject empty file_paths array 7ms
   ✓ ReadTool > execute > should detect binary files 24ms
   ✓ ReadTool > getResultPreview > should show files read count 10ms
   ✓ ReadTool > getResultPreview > should show content preview 6ms
 ✓ src/ui/components/__tests__/ProgressIndicator.test.ts (16 tests) 2ms
 ✓ src/tools/__tests__/LsTool.test.ts (23 tests) 240ms
 ✓ src/tools/__tests__/GrepTool.test.ts (19 tests) 226ms
 ✓ src/llm/__tests__/MessageHistory.test.ts (17 tests) 4ms
 ✓ src/ui/components/__tests__/MarkdownText.test.ts (8 tests) 1ms
 ✓ src/services/__tests__/PathResolver.test.ts (20 tests) 4ms
 ✓ src/ui/components/__tests__/ToolOutputStream.test.ts (15 tests) 2ms
 ✓ src/ui/components/__tests__/DiffDisplay.test.ts (9 tests) 1ms
 ✓ src/ui/components/__tests__/StatusLine.test.ts (5 tests) 1ms
 ✓ src/tools/__tests__/GlobTool.test.ts (20 tests) 262ms
 ✓ src/services/__tests__/SyntaxHighlighter.test.ts (11 tests) 10ms
 ✓ src/services/__tests__/SessionManager.test.ts (33 tests) 383ms
 ❯ src/agent/__tests__/Agent.test.ts (9 tests | 3 failed) 588ms
   × Agent - Interruption Handling > System Reminder Injection > should inject system reminder after interruption 99ms
     → expected 'Mock response' to contain 'interrupted'
   ✓ Agent - Interruption Handling > System Reminder Injection > should remove system reminder after LLM responds 89ms
   ✓ Agent - Interruption Handling > System Reminder Injection > should not inject system reminder when not interrupted 46ms
   ✓ Agent - Interruption Handling > System Reminder Injection > should only inject reminder once after interruption 75ms
   × Agent - Interruption Handling > System Reminder Injection > should handle multiple interruptions correctly 80ms
     → expected false to be true // Object.is equality
   ✓ Agent - Interruption Handling > Isolated Context Tracking > should have its own TokenManager instance 21ms
   ✓ Agent - Interruption Handling > Isolated Context Tracking > should have separate TokenManagers for different agents 43ms
   × Agent - Interruption Handling > Isolated Context Tracking > should track context independently for each agent 94ms
     → expected 0 to be greater than 0
   ✓ Agent - Interruption Handling > Isolated Context Tracking > should maintain separate context when creating specialized agents 41ms
 ✓ src/tests/tools/BashTool.test.ts (11 tests) 1042ms
   ✓ BashTool > execute > should respect timeout  1003ms
 ✓ src/services/__tests__/CommandHistory.test.ts (33 tests) 1086ms
 ❯ src/services/__tests__/ToolResultManager.test.ts (8 tests | 1 failed) 2442ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide bash-specific guidance when truncating bash output  480ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide read-specific guidance when truncating read output  356ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide grep-specific guidance when truncating grep output  356ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide glob-specific guidance when truncating glob output  357ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide ls-specific guidance when truncating ls output  362ms
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should provide generic guidance for unknown tools  341ms
   × ToolResultManager > Tool-Specific Truncation Notices > should include context-aware reason in truncation notice 138ms
     → expected 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx…' to match /truncated due to (critical|high) con…/i
   ✓ ToolResultManager > Tool-Specific Truncation Notices > should not truncate short outputs 49ms
 ✓ src/llm/__tests__/OllamaClient.test.ts (18 tests) 3061ms
   ✓ OllamaClient > Error handling > should handle network errors with retry  1002ms
   ✓ OllamaClient > Error handling > should return error response after max retries  1002ms
   ✓ OllamaClient > Error handling > should handle JSON parse errors with retry  1001ms
 ✓ src/services/__tests__/SessionTitleGenerator.test.ts (18 tests) 5775ms
   ✓ SessionTitleGenerator > cleanup > should timeout if generations take too long  5048ms

 Test Files  14 failed | 24 passed (38)
      Tests  64 failed | 613 passed (677)
   Start at  20:54:37
   Duration  6.14s (transform 1.89s, setup 0ms, collect 4.29s, tests 16.63s, environment 4ms, prepare 1.90s)

